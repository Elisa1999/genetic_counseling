---
title: "consutling"
author: "Zhihui Zhang"
date: "3/28/2022"
output: pdf_document
---

```{r setup, include=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r , include = FALSE}
#package we use
library(readr)
library(stringr)
library(ggplot2)
library(dplyr)
```


```{r , include = FALSE}
#import data
dat <- read_csv('data.csv')
```

## Introduction
The main purpose of this project is evaluating the genetic counseling and germline genetic testing process within the pancreatic adenocarcinoma patient population at Roswell Park Comprehensive Cancer Center. We are mainly interested in investigating the reasons that patients opt out of genetic testing and genetic counseling and the trend of referral rate after the guideline came out. The report can be divided into three parts. The first part will analyze the reason in each step on why people drop out. The second part will focus on the overall trend of the referral rate for 30 months. The third part will compare the referral rate before and after the genetic center offered telehealth and help to answer the question whether people prefer telehealth to in-person meeting. 


## Data Processing 

```{r , include = FALSE}
#second opinion tag 
dat$second_opinion <- str_detect(dat$`Reason No Referral`, pattern = 'second opinion') | str_detect(dat$`Somatic Testing
(y,n,other)`, pattern = 'second opinion')

#number of patients with second opinion
sum(dat$second_opinion)

#the data we will use for the further analysis(exclude patients with second opinion)
dat_1 <- dat[dat$second_opinion == FALSE,]

#referral rate = ordered test / total number
#re-encoding 
dat_1$test <- ifelse(str_detect(dat_1$`Testing Ordered`, pattern = 'yes'), 1, 0)

#referral rate through time 
dat_1$`Initial Appt (#1-30)`[dat_1$`Initial Appt (#1-30)`> 15 & dat_1$`Initial Appt (#1-30)`< 16]  <- 15
dat_1$`Initial Appt (#1-30)`[dat_1$`Initial Appt (#1-30)`> 22 & dat_1$`Initial Appt (#1-30)`< 23]  <- 22

```


## I.Referral rate and its analysis

The overall referral rate is 0.3548387. There are 55 patients ordered the germline genetic test among 155 patients. We will divide the referral process into four parts and analyze the reasons of dropping of during each part. 

### Part.I

### Part.II

### Part.III

### Part.IV






## II. Change of referral rate

```{r, include = FALSE}
#referral rate through time 
dat_2 <- dat_1
dat_2$`Initial Appt (#1-30)`[dat_2$`Initial Appt (#1-30)`> 15 & dat_2$`Initial Appt (#1-30)`< 16]  <- 15
dat_2$`Initial Appt (#1-30)`[dat_2$`Initial Appt (#1-30)`> 22 & dat_2$`Initial Appt (#1-30)`< 23]  <- 22

dat_2$cut_3 <- cut(dat_2$`Initial Appt (#1-30)`, c(1, seq(3, 30, by=3)), include.lowest = T) 
dat_2$cut_6 <- cut(dat_2$`Initial Appt (#1-30)`, c(1, seq(6, 30, by=6)), include.lowest = T) 

```

```{r echo=FALSE, warning=FALSE, message=FALSE}
dat1 <- dat_2 %>% group_by(`Initial Appt (#1-30)`,cut_3) %>%
  summarize(referral_rate= sum(test)/ n(), cut_3) %>% distinct()

dat2 <- dat1 %>% group_by(cut_3) %>%
 summarise(sd = sd(referral_rate),
          referral_rate = mean(referral_rate))


ggplot(dat1 , aes(x = cut_3, y = referral_rate)) +
  geom_jitter(position = position_jitter(0.15), color = "darkgray") + 
  geom_line(aes(group = 1), color="#69b3a2", data = dat2) +
  geom_errorbar(data = dat2, aes(ymin = referral_rate-sd, ymax =referral_rate+sd), width = 0.2)  +
  geom_point(data = dat2, size = 2) + 
  labs(title="Referral rate change per 3 month", x="Month", y="Referral rate")
```

```{r echo=FALSE, message=FALSE}
dat_2$cut_6 <- cut(dat_2$`Initial Appt (#1-30)`, c(1, seq(6, 30, by=6)), include.lowest = T) 

dat1 <- dat_2 %>% group_by(`Initial Appt (#1-30)`,cut_6) %>%
  summarize(referral_rate= sum(test)/ n(), cut_6) %>% distinct()

dat2 <- dat1 %>% group_by(cut_6) %>%
 summarise(sd = sd(referral_rate),
          referral_rate = mean(referral_rate))


ggplot(dat1 , aes(x = cut_6, y = referral_rate)) +
  geom_jitter(position = position_jitter(0.2), color = "darkgray") + 
  geom_line(aes(group = 1), data = dat2,  color="#69b3a2") +
  geom_errorbar(data = dat2, aes(ymin = referral_rate-sd, ymax =referral_rate+sd), width = 0.2)  +
  geom_point(data = dat2, size = 2)+ 
   labs(title="Referral rate change per 6 month", x="Month", y="Referral rate")
```





\newpage

## III.Virtual/Teleheath Impact

In this part, we want to investigate if there is any difference of the referral rate before and after telehealth is provided as an preference options for the patients. 

|Period|Total number of patients|Number of patients who placed a referral|Number of Patients who scheduled a meeting|Number of patients who attended the meeting|Number of Patients who ordered the test|Referral rate|
|----------:|----------:|----------:|----------:|----------:|----------:|----------:|
|Before     |        120|         82|         55|         40|         37|     0.3083|
|After      |         35|         29|         26|         18|         17|     0.4857|
| Telehealth|     -     |     -     |         17|         14|         13|     -     |
|  In-person|     -     |     -     |          5|          4|          4|     -     |
|         NA|     -     |     -     |          4|          0|          0|     -     |
|Total      |        155|        111|         81|         58|         54|     0.3484| 




## Appendix
```{r include = FALSE}
#overall referral rate
sum(dat_1$test)/length(dat_1$test)

#referral rate before and after two options
#before
sum(dat_1$test[dat_1$`Initial Appt (#1-30)`<=22.2])/length(dat_1$test[dat_1$`Initial Appt (#1-30)`<=22.2])
#after
sum(dat$test[dat_1$`Initial Appt (#1-30)`>22.2])/length(dat_1$test[dat_1$`Initial Appt (#1-30)`>22.2])

```

```{r include = FALSE}
#before and after two options

nrow(dat_1 %>% filter(`Initial Appt (#1-30)`<= 22.2)) #total patients before
nrow(dat_1 %>% filter(`Initial Appt (#1-30)` > 22.2)) #total patients after

nrow(dat_1 %>% filter(`Initial Appt (#1-30)`<= 22.2& `# Genetics Referrals`>=1)) #total patients who had referrals before 
nrow(dat_1 %>% filter(`Initial Appt (#1-30)`> 22.2& `# Genetics Referrals`>=1) ) #total patients who had referrals after


nrow(dat_1 %>% filter(`Initial Appt (#1-30)`<= 22.2 & `# Genetics Referrals`>=1&`Genetics Appt Scheduled`== 'yes'))#total patients who scheduled the appt before 
nrow(dat_1 %>% filter(`Initial Appt (#1-30)`> 22.2 & `# Genetics Referrals`>=1&`Genetics Appt Scheduled`== 'yes'))#total patients who scheduled the appt after

nrow(dat_1 %>% filter(`Initial Appt (#1-30)`<= 22.2 & `# Genetics Referrals`>=1&`Genetics Appt Scheduled`== 'yes'& `Attended Appt` == 'yes'))#total patients who scheduled the appt before
nrow(dat_1 %>% filter(`Initial Appt (#1-30)`> 22.2 & `# Genetics Referrals`>=1&`Genetics Appt Scheduled`== 'yes'& `Attended Appt` == 'yes'))#total patients who scheduled the appt after

nrow(dat_1 %>% filter(`Initial Appt (#1-30)`<= 22.2 & `# Genetics Referrals`>=1&`Genetics Appt Scheduled`== 'yes'& `Attended Appt` == 'yes'& `Testing Ordered` == 'yes'))#total patients who ordered the test before 
nrow(dat_1 %>% filter(`Initial Appt (#1-30)`> 22.2 & `# Genetics Referrals`>=1&`Genetics Appt Scheduled`== 'yes'& `Attended Appt` == 'yes'& `Testing Ordered` == 'yes'))#total patients who ordered the test after 


nrow(dat_1 %>% filter(`Initial Appt (#1-30)`> 22.2 & `# Genetics Referrals`>=1&`Genetics Appt Scheduled`== 'yes'& `Virtual Offered` %in% c('yes - preference', 'yes - preference (distance)', 'yes'))) # patients who prefered virtual and scheduled the test
nrow(dat_1 %>% filter(`Initial Appt (#1-30)`> 22.2 & `# Genetics Referrals`>=1&`Genetics Appt Scheduled`== 'yes'& `Virtual Offered` %in% c('no', 'no - preference'))) # patients who prefered person and scheduled the test

table(dat_1 %>% filter(`Initial Appt (#1-30)`> 22.2 & `# Genetics Referrals`>=1&`Genetics Appt Scheduled`== 'yes') %>% select(`Virtual Offered`))

nrow(dat_1 %>% filter(`Initial Appt (#1-30)`> 22.2 & `# Genetics Referrals`>=1&`Genetics Appt Scheduled`== 'yes'& `Attended Appt` == 'yes' & `Virtual Offered` %in% c('yes - preference', 'yes - preference (distance)', 'yes'))) # patients who prefered virtual and attended the test
nrow(dat_1 %>% filter(`Initial Appt (#1-30)`> 22.2 & `# Genetics Referrals`>=1&`Genetics Appt Scheduled`== 'yes'& `Attended Appt` == 'yes'& `Virtual Offered` %in% c('no', 'no - preference'))) # patients who prefered person and attended the test

table(dat_1 %>% filter(`Initial Appt (#1-30)`> 22.2 & `# Genetics Referrals`>=1&`Genetics Appt Scheduled`== 'yes'& `Attended Appt` == 'yes') %>% select(`Virtual Offered`))


table(dat_1 %>% filter(`Initial Appt (#1-30)`> 22.2 & `# Genetics Referrals`>=1&`Genetics Appt Scheduled`== 'yes'& `Attended Appt` == 'yes'&`Testing Ordered` == 'yes') %>% select(`Virtual Offered`))


```
